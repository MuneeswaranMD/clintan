  rules_version = '2';

  service cloud.firestore {
    match /databases/{database}/documents {
      
      // ========== ORDERS ==========
      match /orders/{orderId} {
        allow create: if request.resource.data.userId != null 
                      && request.resource.data.userId is string;
        allow read, update, delete: if request.auth != null 
                                    && request.auth.uid == resource.data.userId;
      }
      
      // ========== PRODUCTS ==========
      match /products/{productId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null 
                                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== INVOICES ==========
      match /invoices/{invoiceId} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== CUSTOMERS ==========
      match /customers/{customerId} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }

      // ========== SUPPLIERS ==========
      match /suppliers/{supplierId} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== COMPANIES ==========
      match /companies/{companyId} {
        allow read, write: if request.auth != null && (
          request.auth.uid == resource.data.userId || 
          request.auth.token.email == 'muneeswaran@averqon.in'
        );
        allow create: if request.auth != null; 
      }
      
      // ========== SETTINGS ==========
      match /settings/{userId} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == userId;
      }
      
      // ========== PAYMENTS ==========
      match /payments/{paymentId} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== RECURRING INVOICES ==========
      match /recurring_invoices/{id} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== CHECKOUT LINKS ==========
      match /checkout_links/{id} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== ESTIMATES ==========
      match /estimates/{estimateId} {
        allow read, write: if request.auth != null 
                          && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }

      // ========== STOCK LOGS ==========
      match /stock_logs/{logId} {
        allow read: if request.auth != null 
                    && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null 
                      && request.auth.uid == request.resource.data.userId;
      }
      
      // ========== ORDER FORM CONFIG ==========
      match /order_form_config/{userId} {
        allow read: if true; // Public access for order form rendering
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
